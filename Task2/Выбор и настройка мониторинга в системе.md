# Задание 2. Мониторинг

## Мотивация
- Сейчас о своях работы системы команда узнает только от пользователей. Это ухудшает пользовательский опыт и снижает лояльность. клиенты переходят к конкурентам, у которых система работает более стабильно. Наличие мониторинга позволило бы реагировать на сбои до того как их массово заметят пользователи
    - Выгода для бизнеса: больше клиентов, меньше отток
- Бизнес планирует увеличение DAU, MAU, что влечет за собой каскадное изменение нагрузки и увеличение вероятности сбоев. Наличие мониторинга позволит улучшить понимание готовности системы к нагрузке, выявить узкие места для масштабирования
    - Выгода для бизнеса: знание узких мест и профилей нагрузки позволит  превентивно принимать меры об увеличении ресурсов для лучшей отказоустойчивости, малорисковое планирование увеличения клиентской базы
- Наличие мониторинга позволит улучшить понимание нагрузки на систему, лучше распределить ресурсы (что может принести финансовую экономию)
    - Выгода для бизнеса: может принести финансовую экономию при правильном распределении ресурсов 
- Мониторинг может позволить получить бизнес-инсайты о наиболее востребованных операциях, профилях нагрузки
    - Выгода для бизнеса: лучшее понимание о влиянии пользовательского сценария на ресурсы системы, Data driven подход в принятии решений о фичах и стоимости инфраструктуры

## Выбор подхода к мониторингу
Главные точки монторинга должны определить:
- базовый мониторинг ресурсов
- как в целом справляется БД MES
- как в целом справляется MES API
- как в целом справляется Redis
- насколько эффективно используется кэширование
- как быстро происходит расчет стоимости в MES
- какая нагрузка от API пользователей (MES)
- состояние очереди на расчет

Методологии:
- RED для API сервисов (в приоритете MES API, дополнительно shop API, CRM API)
- 4 золотых сигнала для MES API
- USE для очереди, S3 хранилища и БД (важно отследить интенсивность использования, которая может привести к деградации)

Базовые метрики для всех сервисов и БД, RabbitMQ, Redis и тд:
- CPU %
- RAM %
- Disk %
- Disk I/O
- Network I/O

**Базы данных** (MES DB в приоритете, S3 storage во втором, остальные DB в третьем):
- Size of db instance (all, used)
    - позволит отследить наличие места
- Number of connections for db instance
    - позволит дебажить ошибки из-за нехватки коннектов
- Cache hit (сколько данных из кэша БД выдается) 
    - может помочь пересмотреть индексацию
- Most long SQL statements (самые долгие запросы)
    - можно собрать с помощью pg_stat_statements, позволит оптимизировать запросы 

S3:
- Size of S3 Storage (all, used)
    - позволит отследить наличие места
- File size
    - позволит лучше понять какие файлы загружают пользователи и возможно ввести ограничения по P95
- Number of connections for db instance
    - позволит дебажить ошибки из-за нехватки коннектов
- Errors counter (read, write)
    - количество ошибок при чтении и записи позволят отследить стабильность S3 хранилища

**RabbitMQ:**
- Number of dead-letter-exchange letters in RabbitMQ
    - позволит отследить потерянные заказы
- Number of message in flight in RabbitMQ
    - позволит отселедить что очередь перестает успевать обрабатывать сообщения (при увеличении метрики)
- Количество не обработанные сообщений в очереди
    - позволит реагировать на увеличение нагрузки, отслеживание bottle neck


**Shop API + CRM API** (приоритет ниже, чем у MES API):
- Response time (latency)
    - длительность ожидания для пользователя и для систем
    - labels:  ```user: user_id or component_name```, ```endpoint: endpoint+request type```
- Number of HTTP request code (200 or 500)
    - labels:  ```endpoint: endpoint+request type, code: 2xx or 5xx```
    - рост метрики с кодом 5xx  означает сбой
- Number of requests (RPS)
    - labels:  ```user: user_id or component_name```, ```endpoint: endpoint+request type```
    - метрика общей нагрузки на API
    - разделение по пользователю и сервису поможет понять один пользователь активно использует систему (поможет выявить DDOS атаку) или нагрузка распределена
- Number of simultanious sessions
- Kb tranferred (received)
- Kb provided (sent)
    - позволит отследить потери пакетов данных, например при загрузке файла в S3

**MES API:**
- Number of requests (RPS) for MES API
    - labels:  ```user: user_id or component_name```, ```endpoint: endpoint+request type```
    - лейбл по пользователю или сервису поможет понять один пользователь активно использует систему (поможет выявить DDOS атаку) или нагрузка распределена
- Number of simultanious sessions for MES API
- Response time (latency) for MES API
    - labels:  ```endpoint: endpoint+request type```
- Number of HTTP 200 for MES API
    - labels:  ```endpoint: endpoint+request type```
- Number of HTTP 500 for MES API
    - labels:  ```endpoint: endpoint+request type```
- Kb tranferred (received) for MES API
- Kb provided (sent) for MES API
    - поможет отследить потерю пакетов данных по пути передачи
- DB error counter
- Cache errors counter
    - стандартные метрики для реагирования на ошибки, если БД или кэш не доступны
- Дополнительные бизнес метрики:
    - Orders in status counters
        - labels: ```status```
    - Time from New order to In progress by operator (histogram)
        - позволит оперативно идентифицировать bottle neck в процессе от создания заказа до взятия его в работу оператором

**calculatioin-service** (в случае не реализованного рефакторинга метрики переходят в раздел MES API):
- calculation duration (гистограмма)
- calculation in progress counter
- DB error counter
- Calculation errors rate
    - доля ошибочных расчетов относительно успешных
    - бизнес метрика количества ошибок при расчете

**Redis:**
- Memory Utilisation for Redis instance (all, used)
    - базовая метрика для оценки насыщения кэша
- cache miss, cache hit rate
    - частота попаадания в кэш позволит оценить результативность стратегии


## План действий
- Развернуть и настроить Prometeus (в основном для RED метрик)
- Настроить scrape в необходимые сервисы
- Настроить сбор системных метрик (CPU, RAM, disk, network) через node_exporter
- Подключить rabbitmq_exporter для RabbitMQ

- Развернуть Grafana для визуализации данных и подключить к Prometeus
- Прдготовить запросы PromQL для метрик
- Настроить панели визуализации
- Настроить алерты по показателям насыщения
- Развернуть стэк логирования
- Настроить логирование, необходимые для метрик, которые не удалось просто скрейпить

# Показатели насыщенности
Критические алерты:
- API errors rate > 5% за 5 мин
- Что то отвалилось (Redis не доступен, DB не доступна, API сервис не доступен)

Важные алерты:
- API services: latency 95p > 2 сек на протяжение 5 мин
- DB CPU % > 85%
- API services: CPU % > 85%
    - действие: автоскейл количества инстансов, где доступно. Где недоступно - алерт в ТГ на команду поддержки
- Calculation errors rate > 30% за 1 час
    - более 30% расчетов закончились ошибкой
    - алерт в ТГ, создание тикета с инцидентом
- скачок RPS RPS now > (RPS now - 5 sec)*10
    - алерт в ТГ

Информационные алерты:
- S3 storage: Storage usage > 80%
    - действие: алерт в ТГ + создание тикета на очистку данных
- Time from New order to In progress by operator > 30 min 
    - алерт бизнес-команде
- calculation duration > 30 min у более чем 5% заказов за {период времени, например неделю}
    - алерт бизнес-команде





