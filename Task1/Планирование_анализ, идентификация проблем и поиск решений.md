# Задание 1. Планирование_анализ, идентификация проблем и поиск решений

### Существующие симптомы: 
- Просроченные заказы: над их изделием работают уже несколько месяцев, хотя обещали закончить за три недели
- Пользователи API не получают заказы
- Долгая прогрузка дашборда заказов по статусам даже с учетом фильтра и пагинации

### Контекст и потребности
- Операторам важно видеть самые новые заказы
- Требуется открыть API для пользователей, что повлечет за собой еще большее увеличение нагрузки
- Система работает как B2B по API и как B2C через онлайн магазин

### Анализ проблемных мест в системе:
- Скорость расчета модели в среднем 2-3 минуты, для сложной модели 30 минут. Увеличение количество заказов в месяц на 100 будет приводить к увеличению очереди на 5 часов в месяц (3 мин * 100 = 5 часов)
    - При последовательной обработке заказов за сутки система произведет расчет 480 заказов (в случае легких моделей) или 48 заказов (в случае сложных моделей)
- Приложение MES работает в единственном инстансе, что не позволяет увеличить скорость параллельной обработки заказов
- CRM API работает с базой данных онлайн магазина напрямую, скорее всего в фоне мониторит новые записи, чем создает лишнюю нагрузку на БД и дополнительную зацепленность
- API пользователи работают в MES в синхронном режиме. Это может приводить к тому, что они работают в приоритете, а заказы от пользователей ожидают в очереди все дольше
- MES работает и как CRUD API контроллер и как калькулятор, они сильно зависят друг от друга. Для этих процессов нужны разные ресурсы и разный профиль нагрузки
- Потеря заказов сигнализирует о том, что могут теряться сообщения и нарушаться идемпотентность сообщений
- Долгая прогрузка страницы для операторов сигнализирует о проблемах с БД либо из-за объема данных, либо из-за сложного запроса, либо из-за повышенной нагрузки
- В продакшн версию деплоят вручную -> длительные релизы скорее всего с простоем т.к. сервисы в единственных инстансах
- Значительные задержки релиза из-за ручного тестирования E2E
- Нет информации о состоянии приложения, кроме жалоб пользователей, низкое observability приложений


### Потенциальные проблемы:
- Все приложения запущены в единственном инстансе, не являются отказостойчивыми в случае ошибок и даже при релизах
- Единственный инстанс БД, отсутствие репликации может привести к деградации при увеличении нагрузки и потере данных при отсутствии бэкапов. Есть гипотеза, что текущая проблема загрузки дашборда операторов упирается именно в ресурсы БД
- Скорее всего отсутсвуют ограничения и rate limits для API пользователей, что может привести к перегрузке системы

### Инициативы для устранения нежелательных ситуаций
Исследование:
- Проанализировать состояние MES API: наличие ошибок, аллокацию ресурсов, величину очереди
- Расследовать проблему пропадающих заказов по API (в какой момент происходит потеря)
- Расследовать длительность статусов заказов онлайн магазинов: выяснить на каком этапе происходит зависание

Инициативы по приоритетам: 
0. В фоне не блокируя остальные инициативы: усиление команды: 1 auto QA, 1 #C для MES
1. Вынести из MES процессы расчета стоимости заказа в отдельный сервис price-calculation с возможностью автоскейлинга при горизонтальном масштабировании
    - Реализовать 2 группы воркеров, для пользователей онлайн магазина и пользователей API так, чтобы можно было регулировать скорость обработки B2B и B2C заказов независимо между собой
    - Эта инициатива позволит убрать bottleneck по расчету стоимости заказов, позволит загрузить производство и исправить сроки для клиентов
2. Внедрить механизмы обеспечения идемпотентности заказов в MES, shop-api для предотвращения дублирования запросов
    дублирующие запросы приводят к высокое загрузке по всем компонентам системы: влияет и на объем данных для дашборда операторов и на человеческий фактор обработки дублей и на скорость расчета и обработки очереди, поэтмоу считаем что это второй приоритет
3. Внедрить механизмы outbox pattern в MES, shop-api для предотвращения потери заказов
    Эта инициатива позволит устранить проблему пропадающих заказов и сохранить контракты API пользователей и удовлетворенность клиентов
4. Внедрить кэширование дашборда по статусам заказов для более быстрой прогрузки страницы операторов
    Допустим, во время исследования мы выяснили, что основной bottleneck именно в калькуляции, а не в ожидании пока оператор возьмет заказ в работу. В таком случае, скорость расчета важнее, чем быстрая прогрузка для операторов.
    После оптимизации расчета заказы на операторов будут поступать значительно оперативнее, база будет пополняться быстрее, этап процесса по отображению заказов может стать следующей точкой скопления.
5. Внедрить инструменты мониторинга, логирования и алертинга (victoria mentics, grafana, opentelementry, zabbix)
    Инициатива позволит более быстро диагностировать проблемы и реагировать на них. Главная задача после исправления основных бизнес стопперов
6. Внедрить rate limit для API пользователей
    На основании мониторинга можно будет изучить действия пользователей API и с помощью rate limits ограничивать злоупотребление сервисом. Задача не в высшем приоритете в условиях того, что воркеры расчета будут разделены по группам API и клиентов

7.1. Внедрить механизмы репликации для нагруженных баз (точно база MES, возможно база shop тоже, см. по мониторингу)
    Кэширование должно снять часть текущей нагрузки на БД, но при дальнейшем масштабировании запросы на обработку данных могут стать точкой отказа.
    Отдельная реплика должна отрабатывать запросы на чтение
7.2. Обеспечить горизонтальное масштабирование остальных сервисов, минимум в двух экземплярах
    Повысит отказоустойчивость и позволит масштабировать бизнес
8. Внедрить автотесты для ускорения тестирования   
    Позволит быстрее релизить новые фичи
9. Рефакторинг: Выделение базы данных для CRM и интеграция с shop-api через API или message queue
    Позволит более гибко развивать систему и меньшими зависимостями и лучшей отказоустойчивостью

### Целевая архитектура:
1. MES разделен на 2 части: MES controller и pricing-calculation. 
    MES controller
        - доступен по API
        - читает задачи от CRM на расчет, регистрирует и роутирует их в pricing-calculation
        - работает со своей БД
        - интегрирован с кэш инструментом (Redis)
        - умеет валидировать и загружать файлы в S3
        - контролирует дубли заданий и проверяет
    pricing-calculation 
        - работает только с очередью
        - читает файлы из S3
        - производит расчет и сообщает стоимость в ответном сообщении
        - rate-limit для API пользователей
2. Внедрен кэш Redis
3. Сервисы запущены в нескольких инстансах в зависимости от нагрузки и метрик производительности
4. PostgreSQL запущен с отдельной репликой для чтения





